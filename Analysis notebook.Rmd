---
title: "Einfluss Ölpreis auf Treibhausgasausstoss "
author: "Rami Tarabishi, Alexander Shanmugam"
date: "`r format(Sys.time(), '%B %Y')`"

output:
  html_document:
    number_sections: true
    toc: true
    toc_depth: 3
    df_print: paged
    toc_float: true
    theme: simplex
    highlight: haddock
    self_contained: no
  pdf_document:
    toc: yes
    toc_depth: '2'

---

&nbsp;   
&nbsp;


# Management Summary {.tabset}
## Fragestellung
Es stellt sich die Frage, ob bei steigenden Ölpreisen, die Kraftwerksbetreiber ihr Portfolio von technologisch unterschiedlichen Kraftwerken längerfristig umbauen – hin zu Technologien mit tiefen SRMC.

Ein solcher Effekt müsste in niedrigeren CO2-Werten pro kWh elektrische Energie sichtbar werden (da die fossilen Kraftwerke abgeschaltet würden). 

Da andere Kosten-Parameter auch eine Rolle spielen können, soll aufgezeigt werden, wie stark (falls ein solcher Effekt existiert) ein solcher vermuteter Effekt ist. 

&nbsp;   
&nbsp;

## Antwort

Noch unklar

&nbsp;   
&nbsp;

# Datenaufbereitung {.tabset}
- Daten werden geladen 
- Wie sehen meine Daten aus? 
```{r libraries, message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)    #opinionated collection of R packages designed for data science
library(summarytools) #providing tools to neatly and quickly summarize data
library(lubridate)    #simplifies working with dates
library(knitr)        #tools to make nice outputs
library(plotly)       #interactive plots
library(httr)         #for http requests (to get data)
library(jsonlite)     #to deal with json
```
```{r get_data}
# get_data <- function(call) {
#   getData <- GET(call)
#   print(status_code(getData))
#   # Getting status of HTTP Call
#   if(status_code(getData) == 200)
#     {
#       # Converting content to text
#       getDataText <- content(getData,
#                                 "text", encoding = "UTF-8")
#       # Parsing data in JSON
#       getDataJson <- fromJSON(getDataText,
#                               flatten = TRUE)
#       return(getDataJson)
#     }
# }

# TODOs:
# installed potential
# https://apidatos.ree.es/en/datos/generacion/potencia-instalada?start_date=2018-01-01T00:00&end_date=2018-12-31T23:59&time_trunc=month
# hourly prices; are these production costs?
# https://apidatos.ree.es/en/datos/mercados/precios-mercados-tiempo-real?start_date=2018-01-01T00:00&end_date=2018-01-31T23:59&time_trunc=hour


# generationData <- data.frame()
# for (i in 2011:2022)
# {
#   if (i != 2022) {
#     call <- paste("https://apidatos.ree.es/en/datos/generacion/estructura-generacion?start_date=", i, "-01-01T00:00&end_date=", i, "-12-31T23:59&time_trunc=day", sep = '')
#   }
#   else {
#     call <- paste("https://apidatos.ree.es/en/datos/generacion/estructura-generacion?start_date=", i, "-01-01T00:00&end_date=", Sys.Date(),"T23:59&time_trunc=day", sep = '')
#   }
#   data <- get_data(call)
#   data <- data$included %>% filter(attributes.title == "Total generation")

#   # Converting into dataframe
#   generationData <- rbind(generationData, as.data.frame(data$attributes.values))
# }
# View(generationData)
# write.csv(generationData, "./Data sets/GenerationData.csv")

# emissions <- data.frame()
# for(i in 2011:2022){
#   if (i != 2022){
#     call <- paste('https://apidatos.ree.es/en/datos/generacion/no-renovables-detalle-emisiones-CO2?start_date=', i, '-01-01T00:00&end_date=', i, '-12-31T23:59&time_trunc=day', sep = '')
#   }
#   else{
#     call <- paste('https://apidatos.ree.es/en/datos/generacion/no-renovables-detalle-emisiones-CO2?start_date=', i, '-01-01T00:00&end_date=', Sys.Date(), 'T23:59&time_trunc=day', sep = '')
#   }
#   data <- get_data(call)
#   data <- data$included %>% filter(groupId == 'Emission factor')

#   emissions <- rbind(emissions, as.data.frame(data$attributes.values)) #tCO2 eq./MWh
#   write.csv(emissions, "./Data sets/Emissions.csv")
# }
# View(emissions)
```

## Oil Price

```{r read-OP, warning=FALSE}
oilPrice <- as_tibble(read.csv('./Data sets/DCOILBRENTEU.csv', header = TRUE)) #source: https://fred.stlouisfed.org/series/DCOILBRENTEU

glimpse(oilPrice)
# Month needs to be converted to a Date Format
oilPrice <- rename(oilPrice, c('Date' = 'DATE', 'Price' = 'DCOILBRENTEU')) %>%
  mutate(Date = ymd(Date), Price = as.numeric(Price), Year = year(Date)) %>%
  arrange(oilPrice, Date)

glimpse(oilPrice)

kable(summary(oilPrice)) #Price: USD per Barrel

view(dfSummary(oilPrice, plain.ascii = FALSE, style = 'grid'), method = 'render')
```

### Grafische Übersicht

```{r plot-OP}
p <- ggplot(oilPrice, aes(Date, Price)) +
  geom_line() +
  ggtitle("Brent Oil Price")
ggplotly(p)
```

## Share of electricity by source
```{r read-SOES}
shareOfElecBySource <- as_tibble(read.csv('./Data sets/share-elec-by-source.csv'))  %>% filter(Code == 'ESP') #source: https://ourworldindata.org/grapher/share-elec-by-source?country=~ESP

glimpse(shareOfElecBySource)

kable(summary(shareOfElecBySource))

view(dfSummary(shareOfElecBySource, plain.ascii = FALSE, style = 'grid'), method = 'render')
```

### Grafische Übersicht
```{r plot-SOES}
shareOfElecBySource_long <- shareOfElecBySource %>% pivot_longer(Coal:Other.renewables, names_to="Source", values_to="Percent")

p <- ggplot(shareOfElecBySource_long, aes(x = Year, y = Percent, color = Source)) +
  geom_line() +
  ggtitle("Share of electricity production by source, Spain")
ggplotly(p)
```

## Electricity prices

```{r read-EP, warning=FALSE}
elecPrices <- as_tibble(read.csv('./Data sets/Electricity_prices_spain.csv') %>% filter(TAX == "All taxes and levies included", CURRENCY == "Euro")) #source: https://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=nrg_pc_204

glimpse(elecPrices)
elecPrices <- elecPrices %>% mutate(Value = as.numeric(Value)) %>%
  select(-CURRENCY, -TAX, -UNIT, -GEO, -PRODUCT, -CONSOM)
elecPrices <- drop_na(elecPrices)

glimpse(elecPrices)

kable(summary(elecPrices)) #Prices in EUR

view(dfSummary(elecPrices, plain.ascii = FALSE, style = 'grid'), method = 'render')
```

### Grafische Übersicht
```{r plot-EP}
p <- ggplot(elecPrices, aes(TIME, Value, group = 1)) +
  geom_line() +
  ggtitle("Electricity price in Spain by Semester")

ggplotly(p)
```

## Energy Generation
```{r read-EG}
energyGeneration <- as_tibble(read.csv('./Data sets/GenerationData.csv')) #https://www.ree.es/en/apidatos

glimpse(energyGeneration) # GWh
energyGeneration <- energyGeneration %>% mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>% select(-datetime)
glimpse(energyGeneration) # MWh
# energyGeneration <- energyGeneration %>% mutate(Year = as.numeric(substr(Year, 1, 4))) %>%
#   rename(c("kwh" = "Spain"))

# glimpse(energyGeneration)

kable(summary(energyGeneration)) #Energy Generation in kWh

view(dfSummary(energyGeneration, plain.ascii = FALSE, style = 'grid'), method = 'render')
```
### Grafische Übersicht
```{r plot-EG}
p <- ggplot(energyGeneration, aes(date, value)) +
  geom_line() +
  labs(y = 'Energy Production in MWh', title = 'Spain\'s Electricity production in MWh')
ggplotly(p)
```
## Emissions
```{r emissions}
emissions <- as_tibble(read.csv("./Data sets/Emissions.csv"))
glimpse(emissions)
emissions <- emissions %>% mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>% select(-datetime, -percentage, -X)
glimpse(emissions) #tCO2 eq./MWh
# co2EmissionsFromEnergy <- data.frame(energyGeneration %>% filter(Year > 2000))

# co2EmissionsFromEnergy <- co2EmissionsFromEnergy %>% mutate(Emissions = 0)

# for (i in 1:nrow(co2EmissionsFromEnergy)) {
#   co2EmissionsFromEnergy[i,] %<>%
#     filter(Year == co2EmissionsFromEnergy[i,]$Year) %>%
#     mutate(Emissions = (kwh * carbonIntensity[i,]$Intensity)/1000000)
# }

# co2EmissionsFromEnergy
```
### Grafische Übersicht
```{r plot-emissions}
# ggplot(co2EmissionsFromEnergy) +
#   geom_line(aes(y = Emissions, x = Year, group = 1), color="#4B1D91CC") +
#   theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
#   ylab("CO2 Emissions (kt)") + xlab("Years 2000 to 2016") + ggtitle("Co2 Emissions from energy generation in Spain")
```


# Analyse

- Alle Daten in einem Dataframe sammeln 
- Reproduzierbares Datensample gruppiert nach Zylinder generieren 
- Passende Attribute selektieren 

```{r}
# data <- carbonIntensity %>% select(-Entity, -Code)
# glimpse(data)
# tail(data)

# oilPriceYearly <- oilPrice %>%
#   group_by(Year) %>%
#   summarise(meanOilPrice = mean(Price, na.rm = TRUE)) %>%
#   filter(Year >= 2000 & Year <= 2020)

# glimpse(oilPriceYearly)
# tail(oilPriceYearly)

# shareOfElecBySource <- shareOfElecBySource %>% filter(Year >= 2000 & Year <= 2020)
# head(shareOfElecBySource)
# tail(shareOfElecBySource)

# elecPricesYearly <- elecPrices %>%
#   mutate(Year = substr(TIME, 1, 4)) %>%
#   filter(Year >= 2000 & Year <= 2020) %>%
#   group_by(Year) %>%
#   summarise(meanElecPrice = mean(Value))
# missingYears <- data.frame(2000:2006, rep(NA, 7))
# colnames(missingYears) <- c('Year', 'meanElecPrice')
# elecPricesYearly <- rbind(missingYears, elecPricesYearly)

# energyGeneration <- energyGeneration %>% filter(Year >= 2000 & Year <= 2020)
# dim(energyGeneration)
# missingYears <- data.frame(2017:2020, rep(NA, 4))
# colnames(missingYears) <- c('Year', 'kwh')
# energyGeneration <- rbind(energyGeneration, missingYears)
# dim(energyGeneration)

# data <- data %>% add_column(oilPriceYearly[,'meanOilPrice'], shareOfElecBySource[,4:10], elecPricesYearly[,'meanElecPrice'])
# glimpse(data)

# kable(summary(data))
data <- oilPrice %>% filter(Year >= 2011) %>% select(-Year)
glimpse(data)
tail(data)
energyGeneration <- energyGeneration %>% filter(date %in% data$Date) %>% mutate(GeneratedEnergy = value) %>% select(-percentage, -date, -X, -value) 
dim(data)
dim(energyGeneration)

emissions <- emissions %>% mutate(emissions = value) %>% select(-value) %>% filter(date %in% data$Date)
dim(emissions)

data <- data %>% cbind(energyGeneration, emissions)
glimpse(data)
data <- data %>% mutate(totalEmissions = emissions * GeneratedEnergy/1000)
glimpse(data)

hist(data$Price)
shapiro.test(data$Price) #Test for normality -> p > .05 is ok


plot(emissions ~ Price, data = data)
abline(lm(emissions ~ Price, data = data))

lm <- lm(emissions ~ Price, data = data)

summary(lm)
```



# Ergebnis / Bewertung