---
title: "Einfluss Ölpreis auf Treibhausgasausstoss "
author: "Rami Tarabishi, Alexander Shanmugam"
date: "`r format(Sys.time(), "%B %Y")`"

output:
  html_document:
    number_sections: true
    toc: true
    toc_depth: 3
    df_print: paged
    toc_float: true
    theme: simplex
    highlight: haddock
    self_contained: no
  pdf_document:
    toc: yes
    toc_depth: "2"

---

&nbsp;   
&nbsp;


# Management Summary {.tabset}
## Fragestellung
Es stellt sich die Frage, ob bei steigenden Ölpreisen, die Kraftwerksbetreiber ihr Portfolio von technologisch unterschiedlichen Kraftwerken längerfristig umbauen - hin zu Technologien mit tiefen SRMC.

Ein solcher Effekt müsste in niedrigeren CO2-Werten pro kWh elektrische Energie sichtbar werden (da die fossilen Kraftwerke abgeschaltet würden). 

Da andere Kosten-Parameter auch eine Rolle spielen können, soll aufgezeigt werden, wie stark (falls ein solcher Effekt existiert) ein solcher vermuteter Effekt ist. 

&nbsp;   
&nbsp;

## Antwort

Noch unklar

&nbsp;   
&nbsp;

# Datenaufbereitung {.tabset}
- Daten werden geladen 
- Wie sehen meine Daten aus? 

```{r libraries, message=FALSE, warning=FALSE, paged.print=FALSE}
# ---- TODOs: ----
# - hourly prices; are these production costs?
# https://apidatos.ree.es/en/datos/mercados/precios-mercados-tiempo-real?start_date=2018-01-01T00:00&end_date=2018-01-31T23:59&time_trunc=hour
#
# - eda for installed potential (read csv, explore data, pack into useful format)
# - research  lifecicle of purchased oil
# - write data to MongoDB

library(tidyverse) # opinionated collection of R packages designed for data science
library(lubridate) # simplifies working with dates
library(knitr) # tools to make nice outputs
library(plotly) # interactive plots
library(jsonlite) # to deal with json
library(mongolite) # to connect to mongodb
```

## Oil Price

```{r read-OP, warning=FALSE}
oil_price_collection <- mongo(collection = "BrentOilPrice", db = "CDA2")
oil_price <- as_tibble(oil_price_collection$find(query = "{}"))

glimpse(oil_price)
# Month needs to be converted to a Date Format
oil_price <- rename(oil_price, c("Date" = "period", "Price" = "value")) %>%
  mutate(Date = ymd(Date), Price = as.numeric(Price), Year = year(Date)) %>%
  arrange(oil_price, Date)

glimpse(oil_price)

kable(summary(oil_price)) # Price: USD per Barrel
```

### Grafische Übersicht

```{r plot-OP}
p <- ggplot(oil_price, aes(Date, Price)) +
  geom_line() +
  ggtitle("Brent Oil Price")
ggplotly(p)
```

## Share of electricity by source
```{r read-SOES}
# renewables
other_renewables_potential_collection <- mongo(collection = "generationPotential-Other renewables-red", db = "ES")
other_renewables_potential <- as_tibble(other_renewables_potential_collection$find("{}"))

hydro_potential_collection <- mongo(collection = "generationPotential-Hydro-red", db = "ES")
hydro_potential <- as_tibble(hydro_potential_collection$find("{}"))

solar_potential_collection <- mongo(collection = "generationPotential-Solar photovoltaic-red", db = "ES")
solar_potential <- as_tibble(solar_potential_collection$find("{}"))

# diesel and oil
diesel_potential_collection <- mongo(collection = "generationPotential-Diesel engines-red", db = "ES")
diesel_potential <- as_tibble(diesel_potential_collection$find("{}"))

share_of_elec_by_source <- cbind(other_renewables_potential, hydro_potential, solar_potential, diesel_potential)
names(share_of_elec_by_source) <- c(
  "otherRenewables", "otherRenewablesPercentage", "otherRenewablesDatetime",
  "hydro", "hydroPercentage", "hydroDatetime",
  "solar", "solarPercentage", "solarDatetime",
  "diesel", "dieselPercentage", "datetime"
)
share_of_elec_by_source <- select(share_of_elec_by_source, -otherRenewablesDatetime, -hydroDatetime, -solarDatetime) %>%
  mutate(datetime = ymd_hms(datetime), date = date(datetime))

glimpse(share_of_elec_by_source)

kable(summary(share_of_elec_by_source))
```

### Grafische Übersicht
```{r plot-SOES}
# shareOfElecBySource_long <- shareOfElecBySource %>% pivot_longer(Coal:Other.renewables, names_to="Source", values_to="Percent")

# p <- ggplot(shareOfElecBySource_long, aes(x = Year, y = Percent, color = Source)) +
#   geom_line() +
#   ggtitle("Share of electricity production by source, Spain")


# p <- ggplot(shareOfElecBySource) +
#   geom_line(aes(x = datetime, y = hydro))

# ggplotly(p)
```

## Electricity prices

```{r read-EP, warning=FALSE}
elec_prices_collection <- mongo(collection = "electricityPrice-Daily market-red", db = "ES")
elec_prices <- as_tibble(elec_prices_collection$find("{}"))

# elecPrices <- as_tibble(read.csv("./dataSets/Electricity_prices_spain.csv") %>%
#  filter(TAX == "All taxes and levies included", CURRENCY == "Euro")) #source: https://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=nrg_pc_204

glimpse(elec_prices)

elec_prices <- mutate(elec_prices, datetime = ymd_hms(datetime), date = date(datetime))

glimpse(elec_prices)

kable(summary(elec_prices)) # Prices in EUR
```

### Grafische Übersicht
```{r plot-EP}
p <- ggplot(elec_prices, aes(datetime, value)) +
  geom_line() +
  ggtitle("Electricity price in Spain")

ggplotly(p)
```

## Energy Generation
```{r read-EG}
energy_generation_diesel_collection <- mongo(collection = "energyGeneration-Diesel engines-red", db = "ES")
energy_generation_diesel <- as_tibble(energy_generation_diesel_collection$find("{}"))

energy_generation_collection <- mongo(collection = "energyGeneration-Total generation-red", db = "ES")
energy_generation <- as_tibble(energy_generation_collection$find("{}"))
# energyGeneration <- as_tibble(read.csv("./dataSets/Spain/energyGeneration/Total generation-energyGeneration.csv")) #https://www.ree.es/en/apidatos

glimpse(energy_generation_diesel)

energy_generation_diesel <- energy_generation_diesel %>%
  mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>%
  select(-datetime)
energy_generation <- energy_generation %>%
  mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>%
  select(-datetime)
glimpse(energy_generation_diesel)


kable(summary(energy_generation_diesel))

## Eurostat data
energy_generation_collection_eurostat <- mongo(collection = "energyGeneration", db = "AT")
energy_generation_eurostat <- energy_generation_collection_eurostat$find("{}")
energy_generation_eurostat <- subset(energy_generation_eurostat, code == "O4000XBIO")$data
energy_generation_eurostat <- as.data.frame(energy_generation_eurostat) %>% mutate(Date = ymd(Date))
```

### Grafische Übersicht
```{r plot-EG}
p <- ggplot(energy_generation_diesel) +
  geom_line(aes(date, value)) +
  labs(y = "Energy Production", title = "Spain\'s Electricity production from Diesel")
ggplotly(p)

p <- ggplot(energy_generation_diesel) +
  geom_line(aes(date, percentage)) +
  labs(y = "Energy Production", title = "Spain\'s Electricity production percentage from Diesel")
ggplotly(p)

p <- ggplot(energy_generation) +
  geom_line(aes(date, value)) +
  labs(y = "Energy Production", title = "Spain\'s total Electricity production")
ggplotly(p)
```

## Emissions
```{r emissions}
emissions_diesel_collection <- mongo(collection = "emissions-Diesel engines-red", db = "ES")
emissions_diesel <- as_tibble(emissions_diesel_collection$find("{}"))

glimpse(emissions_diesel)
emissions_diesel <- emissions_diesel %>%
  mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>%
  select(-datetime)
glimpse(emissions_diesel) # tCO2 eq./MWh
```

### Grafische Übersicht
```{r plot-emissions}
p <- ggplot(emissions_diesel, aes(date, value)) +
  geom_line() +
  labs(y = "Emissions in ?", title = "Spain\'s diesel energy production emissions")
ggplotly(p)
```


# Analyse

- Alle Daten in einem Dataframe sammeln 
- Reproduzierbares Datensample gruppiert nach Zylinder generieren 
- Passende Attribute selektieren 

```{r}
# ---- data prep ----
data <- oil_price %>%
  filter(Year >= 2011) %>%
  select(-Year)
glimpse(data)
tail(data)
energy_generation_diesel <- energy_generation_diesel %>%
  filter(date %in% data$Date) %>%
  mutate(GeneratedEnergy = value) %>%
  select(-percentage, -date, -value)
dim(data)
dim(energy_generation_diesel)

emissions_diesel <- emissions_diesel %>%
  mutate(emissions = value) %>%
  select(-value) %>%
  filter(date %in% data$Date)

dim(emissions_diesel)

data <- data %>% cbind(energy_generation_diesel, emissions_diesel)
glimpse(data)
data$day <- weekdays(data$date)
glimpse(data)


# --- data prep eurostat ---
oil_price$month <- months(oil_price$Date)
oil_price$year <- year(oil_price$Date)
energy_generation_eurostat$month <- months(energy_generation_eurostat$Date)
energy_generation_eurostat$year <- year(energy_generation_eurostat$Date)

oil_price_monthly <- aggregate(Price ~ month + year, oil_price, sum)

data_eurostat <- energy_generation_eurostat %>% merge(oil_price_monthly, by = c("Year", "Month"))
# ---- analysis ----
# hist(data$Price)
# hist(data$emissions)
# shapiro.test(data$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
# shapiro.test(data$emissions)

p <- ggplot(data, aes(Price, GeneratedEnergy, color = year(date))) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Emissions in ?", x = "Brent Oil Price (USD)", title = "Correlation between emissions and the Brent Oil Price Years 2010+")
ggplotly(p)

p <- ggplot(data_eurostat, aes(Price, Value, color = Date)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Emissions in ?", x = "Brent Oil Price (USD)", title = "Correlation between energy generation and the Brent Oil Price Years 2010+")
ggplotly(p)

lm <- lm(emissions ~ Price, data = data)

summary(lm)

p1 <- ggplot(data) +
  geom_line(aes(x = date, y = scale(Price), color = "Price")) +
  geom_smooth(aes(x = date, y = scale(Price), color = "Price smoothed"), method = "loess", span = 0.1, ) +
  geom_smooth(aes(x = date, y = scale(emissions), color = "Emissions smoothed"), method = "loess", span = 0.1, ) +
  geom_line(aes(x = date, y = scale(emissions), color = "Emissions", alpha = .5))

ggplotly(p1)

for (m in unique(year(data$date))) {
  yearly_data <- filter(data, year(date) == m)

  hist(yearly_data$Price)
  hist(yearly_data$GeneratedEnergy)
  shapiro.test(yearly_data$Price) # Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
  shapiro.test(yearly_data$GeneratedEnergy)



  glimpse(yearly_data)
  p2 <- ggplot(yearly_data, aes(Price, GeneratedEnergy, color = date)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(y = "Emissions in ?", x = "Brent Oil Price (USD)", title = paste("Correlation between emissions and the Brent Oil Price Year", m))
  print(p2)

  lm <- lm(GeneratedEnergy ~ Price, data = yearly_data)
  res <- resid(lm)

  plot(fitted(lm), res)

  # add a horizontal line at 0
  abline(0, 0)

  print(summary(lm))
}

# just the year 2019
# data2019 <- filter(data, year(date) == 2019)

# hist(data2019$Price)
# hist(data2019$emissions)
# shapiro.test(data2019$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
# shapiro.test(data2019$emissions)

# p2 <- ggplot(data2019, aes(Price, emissions, color = date)) +
#   geom_point() +
#   geom_smooth(method = "lm") +
#   labs(y = "Emissions in ?", x = "Brent Oil Price (USD)", title = "Correlation between emissions and the Brent Oil Price Year 2019")
# ggplotly(p2)

# glimpse(data2019)
# lm <- lm(emissions ~ Price, data = data2019)

# summary(lm)

# Data past the year 2014
# dataPast2014 <- filter(data, year(date) > 2014)

# hist(dataPast2014$Price)
# hist(dataPast2014$emissions)
# shapiro.test(dataPast2014$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
# shapiro.test(dataPast2014$emissions)

# p2 <- ggplot(dataPast2014, aes(Price, emissions, color = date)) +
#   geom_point() +
#   geom_smooth(method = "lm") +
#   labs(y = "Emissions in ?", x = "Brent Oil Price (USD)", title = "Correlation between emissions and the Brent Oil Price Years 2015+")
# ggplotly(p2)

# glimpse(dataPast2014)
# lm <- lm(emissions ~ Price, data = dataPast2014)

# summary(lm)
```

# Ergebnis / Bewertung