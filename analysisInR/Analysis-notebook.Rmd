---
title: "Einfluss Ölpreis auf Treibhausgasausstoss "
author: "Rami Tarabishi, Alexander Shanmugam"
date: "`r format(Sys.time(), '%B %Y')`"

output:
  html_document:
    number_sections: true
    toc: true
    toc_depth: 3
    df_print: paged
    toc_float: true
    theme: simplex
    highlight: haddock
    self_contained: no
  pdf_document:
    toc: yes
    toc_depth: '2'

---

&nbsp;   
&nbsp;


# Management Summary {.tabset}
## Fragestellung
Es stellt sich die Frage, ob bei steigenden Ölpreisen, die Kraftwerksbetreiber ihr Portfolio von technologisch unterschiedlichen Kraftwerken längerfristig umbauen – hin zu Technologien mit tiefen SRMC.

Ein solcher Effekt müsste in niedrigeren CO2-Werten pro kWh elektrische Energie sichtbar werden (da die fossilen Kraftwerke abgeschaltet würden). 

Da andere Kosten-Parameter auch eine Rolle spielen können, soll aufgezeigt werden, wie stark (falls ein solcher Effekt existiert) ein solcher vermuteter Effekt ist. 

&nbsp;   
&nbsp;

## Antwort

Noch unklar

&nbsp;   
&nbsp;

# Datenaufbereitung {.tabset}
- Daten werden geladen 
- Wie sehen meine Daten aus? 

```{r libraries, message=FALSE, warning=FALSE, paged.print=FALSE}
# ---- TODOs: ----
# - hourly prices; are these production costs?
# https://apidatos.ree.es/en/datos/mercados/precios-mercados-tiempo-real?start_date=2018-01-01T00:00&end_date=2018-01-31T23:59&time_trunc=hour
#
# - eda for installed potential (read csv, explore data, pack into useful format)
# - research  lifecicle of purchased oil
# - write data to MongoDB

library(tidyverse)    #opinionated collection of R packages designed for data science
library(lubridate)    #simplifies working with dates
library(knitr)        #tools to make nice outputs
library(plotly)       #interactive plots
library(httr)         #for http requests (to get data)
library(jsonlite)     #to deal with json
library(mongolite)    #to connect to mongodb
library(cbsodataR)    #Netherland Data
```
## Spain
```{r get_data}
# --- Function to retreive data from API ---
get_data <- function(call) {
  getData <- GET(call)
  print(status_code(getData))
  # Getting status of HTTP Call
  if(status_code(getData) == 200)
    {
      # Converting content to text
      getDataText <- content(getData,
                                "text", encoding = "UTF-8")
      # Parsing data in JSON
      getDataJson <- fromJSON(getDataText,
                              flatten = TRUE)
      return(getDataJson)
    }
}

# --- Function to write retrieved data to files ---
write_spain_generation_data_to_files <- function(path, data, dataType) {
  # dataPerYear <- data.frame()
  for (t in data$type) {
    type <- gsub('[^[:alnum:] ]', '', t)
    # valueText <- paste(type, dataType, sep = '')
    # percentageText <- paste(type, 'Percentage', sep = '')
    dataPerType <- data[data$type == t, ]$attributes.values[[1]]
    filename <- paste(path, dataType, '/', type, '-', dataType, '.csv', sep = '')
    
    if (file.exists(filename)) {
      write.table(dataPerType, file = filename, sep =',', append = TRUE, col.names = FALSE, row.names = FALSE, quote = FALSE)
    } else {
      write.table(dataPerType, file = filename, sep = ',', row.names = FALSE)
    }

    # colnames(dataPerType) <- c(valueText, percentageText, 'datetime')
    # if (t == data$type[1]) {
    #   dataPerYear <- dataPerType
    # } else {
    #   dataPerYear <- merge(dataPerYear, dataPerType, by = intersect(names(dataPerYear), names(dataPerType)), all = TRUE)
    # }
  }
  # filename <- paste(path, dataType, '/all.csv', sep = '')
  # if (file.exists(filename)) {
  #   write.table(dataPerYear, file = filename, sep = ',', row.names = FALSE, append = TRUE, col.names = FALSE, quote = FALSE)
  # } else {
  #   write.table(dataPerYear, file = filename, sep = ',', row.names = FALSE)
  # }
}

# ---- generation Data retrieval ----
for (i in 2011:2022) {
  if (i != 2022) {
    call <- paste("https://apidatos.ree.es/en/datos/generacion/estructura-generacion?start_date=", i, "-01-01T00:00&end_date=", i, "-12-31T23:59&time_trunc=day", sep = '')
  }
  else {
    call <- paste("https://apidatos.ree.es/en/datos/generacion/estructura-generacion?start_date=", i, "-01-01T00:00&end_date=", Sys.Date(),"T23:59&time_trunc=day", sep = '')
  }
  data <- get_data(call)$included
  write_spain_generation_data_to_files('./dataSets/Spain/', data, 'energyGeneration')
}

# ---- emissions Data retreival ----
for (i in 2011:2022) {
  if (i != 2022) {
    call <- paste('https://apidatos.ree.es/en/datos/generacion/no-renovables-detalle-emisiones-CO2?start_date=', i, '-01-01T00:00&end_date=', i, '-12-31T23:59&time_trunc=day', sep = '')
  }
  else{
    call <- paste('https://apidatos.ree.es/en/datos/generacion/no-renovables-detalle-emisiones-CO2?start_date=', i, '-01-01T00:00&end_date=', Sys.Date(), 'T23:59&time_trunc=day', sep = '')
  }
  data <- get_data(call)$included
  write_spain_generation_data_to_files('./dataSets/Spain/', data, 'emissions')
}

# ---- generation potential Data retreival ----
for (i in 2015:2022) { # only available since 2015
  if (i != 2022) {
    call <- paste('https://apidatos.ree.es/en/datos/generacion/potencia-instalada?start_date=', i, '-01-01T00:00&end_date=', i, '-12-31T23:59&time_trunc=month', sep = '')
  }
  else{
    call <- paste('https://apidatos.ree.es/en/datos/generacion/potencia-instalada?start_date=', i, '-01-01T00:00&end_date=', Sys.Date(), 'T23:59&time_trunc=month', sep = '')
  }

  data <- get_data(call)$included
  write_spain_generation_data_to_files('./dataSets/Spain/', data, 'generationPotential')
}
```

## Netherlands
```{r}
energyDataNL <- cbs_get_data("84575ENG") # Energy Production: https://www.cbs.nl/en-gb/figures/detail/84575ENG?q=electricity
egergyMetaDataNL <- cbs_get_meta("84575ENG")

emissionDataNL <- cbs_get_data("37221eng") # Emission Data: https://www.cbs.nl/en-gb/figures/detail/37221eng?q=electricity%20emission Source 346700 = Energy supply
View(emissionDataNL)
```
##

## Oil Price

```{r read-OP, warning=FALSE}
oilPrice <- as_tibble(read.csv('./dataSets/DCOILBRENTEU.csv', header = TRUE)) #source: https://fred.stlouisfed.org/series/DCOILBRENTEU

glimpse(oilPrice)
# Month needs to be converted to a Date Format
oilPrice <- rename(oilPrice, c('Date' = 'DATE', 'Price' = 'DCOILBRENTEU')) %>%
  mutate(Date = ymd(Date), Price = as.numeric(Price), Year = year(Date)) %>%
  arrange(oilPrice, Date)

glimpse(oilPrice)

kable(summary(oilPrice)) #Price: USD per Barrel
```

### Grafische Übersicht

```{r plot-OP}
p <- ggplot(oilPrice, aes(Date, Price)) +
  geom_line() +
  ggtitle("Brent Oil Price")
ggplotly(p)
```

## Share of electricity by source
```{r read-SOES}
shareOfElecBySource <- as_tibble(read.csv('./dataSets/share-elec-by-source.csv'))  %>% filter(Code == 'ESP') #source: https://ourworldindata.org/grapher/share-elec-by-source?country=~ESP

glimpse(shareOfElecBySource)

kable(summary(shareOfElecBySource))
```

### Grafische Übersicht
```{r plot-SOES}
shareOfElecBySource_long <- shareOfElecBySource %>% pivot_longer(Coal:Other.renewables, names_to="Source", values_to="Percent")

p <- ggplot(shareOfElecBySource_long, aes(x = Year, y = Percent, color = Source)) +
  geom_line() +
  ggtitle("Share of electricity production by source, Spain")
ggplotly(p)
```

## Electricity prices

```{r read-EP, warning=FALSE}
elecPrices <- as_tibble(read.csv('./dataSets/Electricity_prices_spain.csv') %>% filter(TAX == "All taxes and levies included", CURRENCY == "Euro")) #source: https://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=nrg_pc_204

glimpse(elecPrices)
elecPrices <- elecPrices %>% mutate(Value = as.numeric(Value)) %>%
  select(-CURRENCY, -TAX, -UNIT, -GEO, -PRODUCT, -CONSOM)
elecPrices <- drop_na(elecPrices)

glimpse(elecPrices)

kable(summary(elecPrices)) #Prices in EUR
```

### Grafische Übersicht
```{r plot-EP}
p <- ggplot(elecPrices, aes(TIME, Value, group = 1)) +
  geom_line() +
  ggtitle("Electricity price in Spain by Semester")

ggplotly(p)
```

## Energy Generation
```{r read-EG}
energyGeneration <- as_tibble(read.csv('./dataSets/Spain/energyGeneration/Total generation-energyGeneration.csv')) #https://www.ree.es/en/apidatos

glimpse(energyGeneration) # GWh
energyGeneration <- energyGeneration %>% mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>% select(-datetime)
glimpse(energyGeneration) # MWh

kable(summary(energyGeneration)) #Energy Generation in kWh
```
### Grafische Übersicht
```{r plot-EG}
p <- ggplot(energyGeneration, aes(date, value)) +
  geom_line() +
  labs(y = 'Energy Production in MWh', title = 'Spain\'s Electricity production in MWh')
ggplotly(p)
```
## Emissions
```{r emissions}
emissions <- as_tibble(read.csv("./dataSets/Spain/emissions/Total tCO2 eq-emissions.csv"))
glimpse(emissions)
emissions <- emissions %>% mutate(datetime = ymd_hms(datetime), date = date(datetime)) %>% select(-datetime)
glimpse(emissions) #tCO2 eq./MWh
```
### Grafische Übersicht
```{r plot-emissions}
p <- ggplot(emissions, aes(date, value)) +
  geom_line() +
  labs(y = 'Emissions in ?', title = 'Spain\'s energy production emissions')
ggplotly(p)
```


# Analyse

- Alle Daten in einem Dataframe sammeln 
- Reproduzierbares Datensample gruppiert nach Zylinder generieren 
- Passende Attribute selektieren 

```{r}
# ---- data prep ----
data <- oilPrice %>% filter(Year >= 2011) %>% select(-Year)
glimpse(data)
tail(data)
energyGeneration <- energyGeneration %>% filter(date %in% data$Date) %>% mutate(GeneratedEnergy = value) %>% select(-percentage, -date, -value) 
dim(data)
dim(energyGeneration)

emissions <- emissions %>% mutate(emissions = value) %>% select(-value) %>% filter(date %in% data$Date)

dim(emissions)

data <- data %>% cbind(energyGeneration, emissions)
glimpse(data)
data <- data %>% mutate(totalEmissions = emissions * GeneratedEnergy/1000)
data$day <- weekdays(data$date)
glimpse(data)

# ---- analysis ----
# hist(data$Price)
# hist(data$emissions)
# shapiro.test(data$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
# shapiro.test(data$emissions)

 p <- ggplot(data, aes(Price, emissions, color = year(date))) +
   geom_point() +
   geom_smooth(method = 'lm') +
   labs(y = 'Emissions in ?', x = "Brent Oil Price (USD)", title = 'Correlation between emissions and the Brent Oil Price Years 2010+')
 ggplotly(p)

 lm <- lm(emissions ~ Price, data = data)

 summary(lm)

p1 <- ggplot(data) +
  geom_line(aes(x = date, y = scale(Price), color = "Price")) +
  geom_smooth(aes(x = date, y = scale(emissions), color = "Emissions smoothed"), method = 'loess', span = 0.1, ) +
  geom_line(aes(x = date, y = scale(emissions), color = "Emissions", alpha = .5))

ggplotly(p1)

for (m in unique(year(data$date))){
  yearlyData <- filter(data, year(date) == m)

  hist(yearlyData$Price)
  hist(yearlyData$emissions)
  shapiro.test(yearlyData$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
  shapiro.test(yearlyData$emissions)



  glimpse(yearlyData)
  p2 <- ggplot(yearlyData, aes(Price, emissions, color = date)) +
    geom_point() +
    geom_smooth(method = 'lm') +
    labs(y = 'Emissions in ?', x = "Brent Oil Price (USD)", title = paste('Correlation between emissions and the Brent Oil Price Month', m))
  print(p2)

  lm <- lm(emissions ~ Price, data = yearlyData)
  res <- resid(lm)

  plot(fitted(lm), res)

  #add a horizontal line at 0 
  abline(0,0)

  print(summary(lm))
}

# just the year 2019
# data2019 <- filter(data, year(date) == 2019)

# hist(data2019$Price)
# hist(data2019$emissions)
# shapiro.test(data2019$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
# shapiro.test(data2019$emissions)

# p2 <- ggplot(data2019, aes(Price, emissions, color = date)) +
#   geom_point() +
#   geom_smooth(method = 'lm') +
#   labs(y = 'Emissions in ?', x = "Brent Oil Price (USD)", title = 'Correlation between emissions and the Brent Oil Price Year 2019')
# ggplotly(p2)

# glimpse(data2019)
# lm <- lm(emissions ~ Price, data = data2019)

# summary(lm)

# Data past the year 2014
# dataPast2014 <- filter(data, year(date) > 2014)

# hist(dataPast2014$Price)
# hist(dataPast2014$emissions)
# shapiro.test(dataPast2014$Price) #Test for normality -> p > .05 is ok -> not ok, we've got a bimodal distribution
# shapiro.test(dataPast2014$emissions)

# p2 <- ggplot(dataPast2014, aes(Price, emissions, color = date)) +
#   geom_point() +
#   geom_smooth(method = 'lm') +
#   labs(y = 'Emissions in ?', x = "Brent Oil Price (USD)", title = 'Correlation between emissions and the Brent Oil Price Years 2015+')
# ggplotly(p2)

# glimpse(dataPast2014)
# lm <- lm(emissions ~ Price, data = dataPast2014)

# summary(lm)
```

# Ergebnis / Bewertung